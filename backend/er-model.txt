Table Владельцы {
    ID_владельца int [pk]
    ФИО varchar
    Адрес varchar
    Телефон varchar
}

Table Организации {
    ID_организации int [pk]
    Название varchar
    Район varchar
    Адрес varchar
    Руководитель varchar
}

Table Номера {
    Госномер varchar [pk]
    Номер int
    Серия varchar
    Статус bool
}

Table Автотранспортные_средства {
    ID_авто int [pk]
    ID_Марка int [ref: > Марки_ТС.ID_марки]
    Дата_выпуска date
    Объем_двигателя float
    Номер_двигателя varchar
    Номер_шасси varchar
    Номер_кузова varchar
    Цвет varchar
    Тип_ТС enum ('Легковой', 'Грузовой', 'Мотоцикл', 'Автобус', 'Прицеп')
    Госномер varchar [ref: - Номера.Госномер]
    ID_владельца int [ref: > Владельцы.ID_владельца] //nullable
    ID_организации int [ref: > Организации.ID_организации] //nullable
    ID_сигнализации int [ref: > Сигнализации.ID_сигнализации] // nullable
}

Table Технический_осмотр {
    ID_ТО int [pk]
    ID_авто int [ref: > Автотранспортные_средства.ID_авто]
    Дата_проверки date
    Результат varchar
    Следующая_дата_ТО date
}

Table ДТП {
    ID_ДТП int [pk]
    Дата date
    Место Point
    Тип_происшествия varchar
    Краткое_содержание text
    Число_пострадавших int
    Сумма_ущерба float
    Причина varchar
    Условия_дороги varchar
}

Table Участники_ДТП {
    ID_участника int [pk]
    ID_ДТП int [ref: > ДТП.ID_ДТП]
    ID_авто int [ref: > Автотранспортные_средства.ID_авто]
    Роль enum ('Виновник', 'Пострадавший', 'Свидетель')
}

Table Розыск {
    ID_розыска int [pk]
    ID_авто int [ref: > Автотранспортные_средства.ID_авто]
    Дата_добавления date
    Причина_розыска varchar
    Статус enum ('В розыске', 'Найден') 
}

Table Сигнализации {
    ID_сигнализации int [pk]
    Наименование varchar
    Надежность varchar
}

Table Марки_ТС {
    ID_марки int [pk]
    Наименование varchar
    Популярность_угонов varchar
}

Table Угонов {
    ID_угон int [pk]
    ID_авто int [ref: > Автотранспортные_средства.ID_авто]
    Дата_угон date
    Место Point
    Описание text
}

Table КуплиПродажы {
    ID_сделки int [pk]
    ID_авто int [ref: > Автотранспортные_средства.ID_авто]
    Дата date
    Стоимость float
    ID_покупатель int [ref: > Владельцы.ID_владельца] //nullable
    ID_продавец int [ref: > Владельцы.ID_владельца] //nullable
}

Table Диапазоны_свободных_номеров {
    Серия varchar
    Начальный_номер int
    Конечный_номер int
}


Запросы:
1. Получить перечень и общее число организаций, которым выделены номера либо с указанной серией, либо за указанный период.
SELECT 
    o.Название,
    COUNT(*) AS Общее_число
FROM 
    Организации o
JOIN 
    Автотранспортные_средства a ON o.ID_организации = a.ID_организации
JOIN 
    Номера n ON a.Госномер = n.Госномер
WHERE 
    (n.Серия = 'Указанная_серия' OR 
     n.Дата BETWEEN '2023-01-01' AND '2023-12-31')
GROUP BY 
    o.Название;

2. Получить сведения о владельце автотранспортного средства по государственному номеру автомашины.
SELECT 
    v.ФИО,
    v.Адрес,
    v.Телефон
FROM 
    Владельцы v
JOIN 
    Автотранспортные_средства a ON v.ID_владельца = a.ID_владельца
WHERE 
    a.Госномер = 'Указанный_госномер';

3. Получить "досье" на автомобиль по государственному номеру - номера двигателя, кузова и шасси, участвовал ли в ДТП, прошел ли техосмотр.
SELECT 
    a.Номер_двигателя,
    a.Номер_шасси,
    a.Номер_кузова,
    CASE 
        WHEN dtp.ID_ДТП IS NOT NULL THEN 'Да'
        ELSE 'Нет'
    END AS Участвовал_в_ДТП,
    CASE 
        WHEN tos.Результат = 'Пройден' THEN 'Да'
        ELSE 'Нет'
    END AS Прошел_техосмотр
FROM 
    Автотранспортные_средства a
LEFT JOIN 
    Участники_ДТП udp ON a.ID_авто = udp.ID_авто
LEFT JOIN 
    ДТП dtp ON udp.ID_ДТП = dtp.ID_ДТП
LEFT JOIN 
    Технический_осмотр tos ON a.ID_авто = tos.ID_авто
WHERE 
    a.Госномер = 'Указанный_госномер';

4. Получить перечень и общее число владельцев машин не прошедших вовремя техосмотр.
SELECT 
    v.ФИО,
    COUNT(*) OVER () AS Общее_число
FROM 
    Владельцы v
JOIN 
    Автотранспортные_средства a ON v.ID_владельца = a.ID_владельца
JOIN 
    Технический_осмотр tos ON a.ID_авто = tos.ID_авто
WHERE 
    tos.Следующая_дата_ТО < CURRENT_DATE;

5. Получить статистику по любому типу ДТП за указанный период.
SELECT 
    dtp.Тип_происшествия,
    COUNT(*) AS Количество_ДТП
FROM 
    ДТП dtp
WHERE 
    dtp.Дата BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY 
    dtp.Тип_происшествия;

6. Получить результаты анализа ДТП: самые опасные места в городе, самая частая причина ДТП.
-- Самые опасные места
сложная фигня

-- Самая частая причина ДТП
SELECT 
    dtp.Причина,
    COUNT(*) AS Количество_ДТП
FROM 
    ДТП dtp
GROUP BY 
    dtp.Причина
ORDER BY 
    Количество_ДТП DESC
LIMIT 1;

7. Получить данные о количестве ДТП, совершаемых водителями в нетрезвом виде и доля таких происшествий в общем количестве ДТП.
SELECT 
    SUM(CASE WHEN dtp.Причина = 'Нетрезвое_состояние' THEN 1 ELSE 0 END) AS ДТП_нетрезвые,
    COUNT(*) AS Общее_количество_ДТП,
    ROUND(
        SUM(CASE WHEN dtp.Причина = 'Нетрезвое_состояние' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 
        2
    ) AS Доля_нетрезвых_ДТП
FROM 
    ДТП dtp;

8. Получить список машин, отданных в розыск, будь то скрывшиеся с места ДТП или угнанные.
SELECT DISTINCT 
    a.Госномер
FROM 
    Автотранспортные_средства a
JOIN 
    Розыск r ON a.ID_авто = r.ID_авто
UNION
SELECT DISTINCT 
    a.Госномер
FROM 
    Автотранспортные_средства a
JOIN 
    Угонов u ON a.ID_авто = u.ID_авто;

9. Получить данные об эффективности розыскной работы: количество найденных машин в процентном отношении.
SELECT 
    COUNT(CASE WHEN r.Статус = 'Найден' THEN 1 END) AS Найдено,
    COUNT(*) AS Всего_розыск,
    ROUND(
        COUNT(CASE WHEN r.Статус = 'Найден' THEN 1 END) * 100.0 / COUNT(*), 
        2
    ) AS Эффективность_розыска
FROM 
    Розыск r;

10. Получить перечень и общее число угонов за указанный период.
SELECT 
    m.Наименование AS Марка,
    COUNT(*) AS Количество_угонов
FROM 
    Угонов u
JOIN 
    Автотранспортные_средства a ON u.ID_авто = a.ID_авто
JOIN 
    Марки_ТС m ON a.ID_Марка = m.ID_марки
WHERE 
    u.Дата_угон BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY 
    m.Наименование;

11. Получить статистику по угонам: самые угоняемые марки машин, самые надежные сигнализации и т.п.
-- Самые угоняемые марки
SELECT 
    m.Наименование AS Марка,
    COUNT(*) AS Количество_угонов
FROM 
    Угонов u
JOIN 
    Автотранспортные_средства a ON u.ID_авто = a.ID_авто
JOIN 
    Марки_ТС m ON a.ID_Марка = m.ID_марки
GROUP BY 
    m.Наименование
ORDER BY 
    Количество_угонов DESC
LIMIT 10;

-- Самые надежные сигнализации
SELECT 
    s.Наименование AS Сигнализация,
    COUNT(u.ID_угон) AS Количество_угонов
FROM 
    Сигнализации s
LEFT JOIN 
    Автотранспортные_средства a ON s.ID_сигнализации = a.ID_сигнализации
LEFT JOIN 
    Угонов u ON a.ID_авто = u.ID_авто
GROUP BY 
    s.Наименование
ORDER BY 
    Количество_угонов ASC
LIMIT 10;

